{% block title %}
<!-- Your Page Title -->
{% endblock %}

{% block content %}
<style>
  /* Container for the form - center and responsive max width */
  form {
  width: 100%;
  max-width: none;
  margin: 20px auto;
  padding: 20px 25px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

  /* Intro paragraph styling */
  form > p {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 30px;
    color: #333;
  }

  /* Each question container */
  .form-group {
    margin-bottom: 28px;
  }

  /* Question label styling */
  .form-group > label {
    display: block;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 12px;
    color: #222;
  }

  /* Container for radio/checkbox options */
.options-container {
  display: block;  /* no flex */
  gap: 12px; /* gap doesn't work with block but you can add margin */
}

.option {
  display: flex;
  align-items: center;
  cursor: pointer;
  margin-bottom: 12px; /* space between options */
  min-width: 140px; /* keep this or adjust as needed */
}

  /* Input radios and checkboxes */
  input[type="radio"],
  input[type="checkbox"] {
    margin-right: 10px;
    cursor: pointer;
  }

  /* Labels for options */
  .option label {
    font-weight: 400;
    font-size: 0.95rem;
    color: #444;
    user-select: none;
  }

  /* For watermark images with selectable borders */
  #follow-up-question div {
    flex: 1 1 48%;
    margin-bottom: 16px;
  }

  #follow-up-question div label {
    cursor: pointer;
    display: inline-block;
  }

  #follow-up-question div img {
    max-width: none;
    height: auto;
    border-radius: 5px;
    transition: border-color 0.3s ease;
    border: 2px solid transparent;
  }

  /* Submit button container */
  .submit-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 30px;
  }

  button[type="submit"] {
    background-color: #2c7be5;
    color: white;
    border: none;
    padding: 10px 22px;
    font-size: 1.3rem;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(44,123,229,0.4);
    transition: background-color 0.25s ease;
  }

  button[type="submit"]:hover {
    background-color: #1a5fd9;
  }

  /* ===== ERROR MESSAGE STYLES (matching second page) ===== */
  .error-message {
    color: red !important;
    font-size: 0.75rem !important;
    padding: 4px 6px !important;
    white-space: normal !important;
    word-break: break-word !important;
    display: block !important;
    max-width: 100% !important;
    overflow-wrap: break-word !important;
    margin-top: 4px;
    min-height: 16px;
  }

  /* Validation highlighting styles (matching second page) */
  .missing-answer {
    background-color: #ffebee !important;
    border: 2px solid #f44336 !important;
    border-radius: 4px;
    padding: 8px;
    margin: 4px 0;
    animation: pulse-red 1s ease-in-out;
  }

  .missing-answer .form-group > label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer p {
    color: #d32f2f !important;
    font-weight: bold;
  }

  @keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
    100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
  }
</style>

<script>
  // Enhanced validation function with highlighting and popup messages
  function validateForm() {
    console.log('validateForm() called');

    // Define field names with their user-friendly labels
    const requiredFields = {
      'all_images': 'How many images you saw on the previous page',
      'loading': 'Whether the images loaded quickly enough',
      'interaction': 'Whether you were able to interact with the posts',
      'political_content': 'How many images contained political content',
      'watermark_familiarity': 'Your familiarity with watermarks or warning labels',
      'watermark_manipulation_check': 'Whether any images had a watermark, label, or content warning'
    };

    const form = document.querySelector('form');
    if (!form) {
      console.log('Form not found');
      return true; // Let it submit if we can't find form
    }

    let unansweredFields = [];
    let missingElements = [];

    // Clear any previous highlighting
    document.querySelectorAll('.missing-answer').forEach(el => {
      el.classList.remove('missing-answer');
    });

    // Check each required field and collect missing ones
    Object.keys(requiredFields).forEach(function(fieldName) {
      let isAnswered = false;

      // Check if it's a radio button group
      const radioInputs = form.querySelectorAll(`input[name="${fieldName}"][type="radio"]`);
      if (radioInputs.length > 0) {
        // It's a radio group - check if any is selected
        const checked = form.querySelector(`input[name="${fieldName}"]:checked`);
        isAnswered = checked !== null;
      }

      if (!isAnswered) {
        unansweredFields.push(requiredFields[fieldName]);

        // Find and highlight the question container
        const fieldContainer = radioInputs[0].closest('.form-group');
        if (fieldContainer) {
          fieldContainer.classList.add('missing-answer');
          missingElements.push(fieldContainer);
        }
      }
    });

    // Special validation for follow-up watermark question
    const followUpQuestion = document.getElementById('follow-up-question');
    const watermarkAnswer = document.querySelector('input[name="watermark_manipulation_check"]:checked');

    if (followUpQuestion && followUpQuestion.style.display !== 'none' && watermarkAnswer && watermarkAnswer.value === '1') {
      const anyChecked = Array.from(document.querySelectorAll('.watermark-checkbox')).some(cb => cb.checked);

      if (!anyChecked) {
        unansweredFields.push('Selection of which image(s) had a watermark');
        followUpQuestion.classList.add('missing-answer');
        missingElements.push(followUpQuestion);
      }
    }

    if (unansweredFields.length > 0) {
      console.log('Validation failed. Unanswered fields:', unansweredFields);

      // Create detailed popup error message
      let message = 'Please answer the following question';
      if (unansweredFields.length > 1) {
        message += 's';
      }
      message += ' before submitting:\n\n';

      unansweredFields.forEach(function(fieldLabel, index) {
        message += '• ' + fieldLabel;
        if (index < unansweredFields.length - 1) {
          message += '\n';
        }
      });

      alert(message);

      // Scroll to first missing question
      if (missingElements.length > 0) {
        missingElements[0].scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }

      return false; // Prevent form submission
    }

    console.log('Validation passed');
    return true; // Allow form submission
  }

  // Function to show/hide follow-up question
  function toggleFollowUp(show) {
    const followUpQuestion = document.getElementById('follow-up-question');
    if (show) {
      followUpQuestion.style.display = 'block';
    } else {
      followUpQuestion.style.display = 'none';
      // Clear any selections when hiding
      document.querySelectorAll('.watermark-checkbox').forEach(cb => {
        cb.checked = false;
      });
      document.getElementById('watermark_image_check_input').value = '[]';
    }

    // Remove highlighting when user makes a selection
    const container = document.querySelector('input[name="watermark_manipulation_check"]').closest('.form-group');
    if (container && container.classList.contains('missing-answer')) {
      container.classList.remove('missing-answer');
    }
  }

  // Setup event listeners when DOM loads
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up validation...');

    // Setup form submission validation
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
      form.addEventListener('submit', function(e) {
        console.log('Form submit intercepted');
        if (!validateForm()) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      }, true);
    });

    // Setup real-time validation feedback
    const allInputs = document.querySelectorAll('input, select, textarea');
    allInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        // Remove highlighting when question is answered
        const container = this.closest('.form-group');
        if (container && container.classList.contains('missing-answer')) {
          container.classList.remove('missing-answer');
        }
      });
    });

    // Setup checkbox handling for watermark images
    const checkboxes = document.querySelectorAll('.watermark-checkbox');
    const hiddenInput = document.getElementById('watermark_image_check_input');

    function updateHiddenInput() {
      const checkedValues = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      hiddenInput.value = JSON.stringify(checkedValues);

      // Remove highlighting when checkboxes are selected
      const followUpQuestion = document.getElementById('follow-up-question');
      if (checkedValues.length > 0 && followUpQuestion.classList.contains('missing-answer')) {
        followUpQuestion.classList.remove('missing-answer');
      }
    }

    // Initialize checkboxes from hidden input value
    try {
      const saved = JSON.parse(hiddenInput.value || '[]');
      if (Array.isArray(saved)) {
        checkboxes.forEach(cb => {
          cb.checked = saved.includes(cb.value);
        });
      }
    } catch(e) {
      // ignore JSON parse errors
    }
    updateHiddenInput();

    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateHiddenInput);
    });
  });

  // Intercept submit button clicks
  document.addEventListener('click', function(e) {
    if (e.target && (e.target.type === 'submit' || e.target.getAttribute('type') === 'submit')) {
      console.log('Submit button clicked, validating...');
      if (!validateForm()) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
    }
  }, true);
</script>

<form method="post">

  <p>
    <strong> Previously in the survey, we showed you a page with a feed from a simulated social media platform. We next have a few questions about that feed that you saw. </strong>
  </p>

<!--   Question 1-->
  <div class="form-group">
    <label>How many images did you see on the previous simulated social media page?</label>
    <div class="options-container">
      {% for i in range(11) %}
      <div class="option">
        <input type="radio" id="all_images_{{i}}" name="all_images" value="{{i}}" required>
        <label for="all_images_{{i}}">{{i}}</label>
      </div>
      {% endfor %}
    </div>
    <div class="error-message" id="all_images_error"></div>
  </div>

  <!-- Question 2 -->
  <div class="form-group">
    <label>Did the images load quickly enough for you on the previous social media page?</label>
    <div class="options-container">
      <div class="option">
        <input type="radio" id="loading_yes" name="loading" value="1" required>
        <label for="loading_yes">Yes</label>
      </div>
      <div class="option">
        <input type="radio" id="loading_no" name="loading" value="2">
        <label for="loading_no">No</label>
      </div>
    </div>
    <div class="error-message" id="loading_error"></div>
  </div>

  <!-- Question 3 -->
  <div class="form-group">
    <label>Were you able to interact with the posts (like, repost, or reply) on the previous social media page?</label>
    <div class="options-container">
      <div class="option">
        <input type="radio" id="interaction_yes" name="interaction" value="1" required>
        <label for="interaction_yes">Yes, I tried and was able to interact.</label>
      </div>
      <div class="option">
        <input type="radio" id="interaction_no" name="interaction" value="2">
        <label for="interaction_no">No, I tried but could not interact.</label>
      </div>
      <div class="option">
        <input type="radio" id="interaction_didnottry" name="interaction" value="3">
        <label for="interaction_didnottry">I did not try to interact.</label>
      </div>
      <div class="option">
        <input type="radio" id="interaction_unsure" name="interaction" value="4">
        <label for="interaction_unsure">Not sure/Don't remember</label>
      </div>
    </div>
    <div class="error-message" id="interaction_error"></div>
  </div>

  <!-- Question 4 -->
  <div class="form-group">
    <label>In your opinion, how many of the images on the previous social media page contained political content?</label>
    <div class="options-container">
      {% for i in range(11) %}
      <div class="option">
        <input type="radio" id="political_content_{{i}}" name="political_content" value="{{i}}" required>
        <label for="political_content_{{i}}">{{i}}</label>
      </div>
      {% endfor %}
    </div>
    <div class="error-message" id="political_content_error"></div>
  </div>

  <!-- Question 5 -->
  <div class="form-group">
    <label>Before today, how familiar were you with the idea of watermarks or warning labels on social media?</label>
    <div class="options-container">
      <div class="option">
        <input type="radio" id="watermark_familiarity_very" name="watermark_familiarity" value="1" required>
        <label for="watermark_familiarity_very">Very familiar</label>
      </div>
      <div class="option">
        <input type="radio" id="watermark_familiarity_somewhat" name="watermark_familiarity" value="2">
        <label for="watermark_familiarity_somewhat">Somewhat familiar</label>
      </div>
      <div class="option">
        <input type="radio" id="watermark_familiarity_not" name="watermark_familiarity" value="3">
        <label for="watermark_familiarity_not">Not familiar at all</label>
      </div>
    </div>
    <div class="error-message" id="watermark_familiarity_error"></div>
  </div>

  <!-- Question 6 -->
  <div class="form-group">
    <label>If you recall, did any of the images on the previous social media page have a watermark, label, or content warning?</label>
    <div class="options-container">
      <div class="option">
        <input type="radio" name="watermark_manipulation_check" value="1" id="wm_yes" onclick="toggleFollowUp(true)" required>
        <label for="wm_yes">Yes</label>
      </div>
      <div class="option">
        <input type="radio" name="watermark_manipulation_check" value="2" id="wm_no" onclick="toggleFollowUp(false)">
        <label for="wm_no">No</label>
      </div>
      <div class="option">
        <input type="radio" name="watermark_manipulation_check" value="3" id="wm_not_sure" onclick="toggleFollowUp(false)">
        <label for="wm_not_sure">Not sure</label>
      </div>
    </div>
    <div class="error-message" id="watermark_manipulation_check_error"></div>
  </div>

  <!-- Follow-up watermark images -->
  <div class="form-group" id="follow-up-question" style="display:none;">
  <label>Select all the images that had a watermark, label, or content warning.</label>
  {{ formfield_errors 'watermark_image_check' }}
  <div class="options-container" style="gap: 15px;">
    {% for option in image_options %}
    <div>
      <!-- Remove [] from the name -->
      <input type="checkbox"
             class="watermark-checkbox"
             id="watermark_image_check_{{ forloop.counter }}"
             value="{{ forloop.counter }}">
      <label for="watermark_image_check_{{ forloop.counter }}">
        <img src="{{ option }}" alt="Option {{ forloop.counter }}" style="max-width: 100%">
      </label>
    </div>
    {% endfor %}
  </div>

  <!-- Hidden input to store all checked values as JSON string -->
  <input type="hidden" name="watermark_image_check" id="watermark_image_check_input"
       value="{% if player.field_maybe_none('watermark_image_check') %}
    <p>You selected: {{ player.watermark_image_check }}</p>
{% endif %}
">
<div class="error-message" id="watermark_image_check_error"></div>
</div>

  <div class="submit-container">
    <button type="submit" id="submitButton" aria-label="Submit survey responses">
      ➔
    </button>
  </div>
</form>

{% endblock %}