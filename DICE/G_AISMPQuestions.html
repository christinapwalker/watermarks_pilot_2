{% extends "global/Page.html" %}

{% block content %}
<style>
  /* ===== Base Styles ===== */
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #222;
    background-color: #f9f9f9;
    margin: 0;
    padding: 0;
  }

  .survey-container {
    max-width: 1400px;
    margin: 40px auto;
    background: white;
    padding: 30px 40px;
    border-radius: 6px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
  }

  p {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .question-label {
    font-size: 1.3rem;
    font-weight: 600;
    color: #222;
  }

  /* ===== Radio Button Container Styling (FIX FOR MOBILE) ===== */
  .form-group div {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 8px;
  }

  .form-group input[type="radio"] {
    flex-shrink: 0;
    margin: 0;
    margin-top: 2px; /* Slight adjustment to align with first line of text */
  }

  .form-group label {
    flex: 1;
    font-size: 1rem;
    font-weight: 400;
    color: #333;
    line-height: 1.4;
    cursor: pointer;
    margin: 0;
  }

  /* ===== Table Styles ===== */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 18px;
    margin-bottom: 40px;
  }

  th, td {
    padding: 12px;
    text-align: center;
    vertical-align: middle;
    font-size: 0.95rem;
    color: #333;
  }

  th {
    font-weight: 600;
    background: #f1f1f1;
    border-bottom: 2px solid #ddd;
  }

  /* Question Column */
  .question-column {
    width: 20%;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    text-align: left;
    font-weight: 600;
    color: #222;
  }
  /* ===== Slider Styles ===== */
  .slider-container {
    position: relative;
    width: 100%;
    margin-bottom: 60px;
    padding: 0;
  }

  .slider {
    width: 100%;
    height: 14px;
    background: #ddd;
    border-radius: 7px;
    margin-bottom: 40px;
    appearance: none;
    outline: none;
  }

  .slider-value {
    text-align: center;
    font-size: 1.3rem;
    font-weight: 600;
    color: #444;
    margin-top: -20px;
  }

  .slider-labels {
    position: relative;
    height: 80px;
    width: 100%;
    user-select: none;
  }

  .slider-labels span {
    position: absolute;
    top: 0;
    transform: rotate(60deg) translateY(6px);
    transform-origin: top center;
    font-size: 0.8rem;
    white-space: nowrap;
    text-align: center;
  }

  /* Position slider labels */
  .slider-labels span:nth-child(1) { left: 0%; }
  .slider-labels span:nth-child(2) { left: 16.666%; }
  .slider-labels span:nth-child(3) { left: 33.333%; }
  .slider-labels span:nth-child(4) { left: 50%; }
  .slider-labels span:nth-child(5) { left: 66.666%; }
  .slider-labels span:nth-child(6) { left: 83.333%; }
  .slider-labels span:nth-child(7) { left: 90%; }


  /* ----- Matrix Table Specific Styles ----- */
  .matrix-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 40px;
    table-layout: fixed;
  }

  .matrix-table th,
  .matrix-table td {
    border: 1px solid #ddd;
    padding: 10px 8px;
    text-align: center;
    vertical-align: middle;
    font-size: 1rem;
    color: #333;
  }
  /* Add this to your existing styles, around line 140 or in the matrix-table section */

.matrix-table td {
  direction: ltr; /* Force left-to-right direction */
}

/* Ensure radio buttons render in correct order on all devices */
.matrix-table tbody td:not(.question-column) {
  direction: ltr;
  text-align: center;
}

.matrix-table .question-column {
  width: 30%;
  max-width: 30%;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  text-align: left;
  font-weight: 600;
  color: #222;
}


  /* Radio Answer Columns */
  .matrix-table th:not(:first-child),
  .matrix-table td:not(.question-column) {
    padding: 4px 2px;
    font-size: 0.85rem;
    word-break: normal;
    text-align: center;
  }

  /* Radio Inputs */
  .matrix-table input[type="radio"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  /* Hide mobile labels on desktop */
  .matrix-table td label.mobile-label {
    display: none;
  }

  /* Wrapper for horizontal scroll on small screens */
  .matrix-wrapper {
    overflow-x: auto;
    width: 100%;
  }

  .matrix-wrapper {
    overflow-x: hidden;
    width: 100%;
  }

  /* ===== ERROR STYLING (matching other pages) ===== */
  /* Validation highlighting styles */
  .missing-answer {
    background-color: #ffebee !important;
    border: 2px solid #f44336 !important;
    border-radius: 4px;
    padding: 8px;
    margin: 4px 0;
    animation: pulse-red 1s ease-in-out;
  }

  .missing-answer .question-column {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer .question-label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer p {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer > label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  /* Special styling for matrix table rows with missing answers */
  .missing-answer-row {
    background-color: #ffebee !important;
    animation: pulse-red 1s ease-in-out;
  }

  .missing-answer-row td {
    background-color: #ffebee !important;
    border: 1px solid #f44336 !important;
  }

  .missing-answer-row .question-column {
    color: #d32f2f !important;
    font-weight: bold;
  }

  @keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
    100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
  }

  /* Submit button container */
  .submit-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 30px;
  }

  button[type="submit"] {
    background-color: #2c7be5;
    color: white;
    border: none;
    padding: 10px 22px;
    font-size: 1.3rem;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(44,123,229,0.4);
    transition: background-color 0.25s ease;
  }

  button[type="submit"]:hover {
    background-color: #1a5fd9;
  }

@media (max-width: 700px) {
  .matrix-table {
    table-layout: fixed;
  }

  .matrix-table th,
  .matrix-table td {
    font-size: 0.65rem;
    padding: 4px 2px;
  }

/* Apply height only to social media platforms and AI tables */
#smp-matrix-wrapper .matrix-table thead tr,
#ai-matrix-wrapper .matrix-table thead tr {
  height: 160px;
}

  .matrix-table th:not(:first-child) {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    text-align: left;
    padding: 5px;
    font-size: 0.6rem;
    height: 100px;
    vertical-align: bottom;
  }

    /* Override colgroup widths on mobile */
  .matrix-table colgroup col:first-child {
    width: 40% !important;
  }

  .matrix-table colgroup col:not(:first-child) {
    width: auto !important;
  }


  .matrix-table .question-column {
    font-size: 0.65rem;
     width: 60% !important;
  max-width: 60% !important;  /* Add this line */
    padding-right: 3px;
    }

  /* Make matrix radio buttons much smaller on mobile */
  .matrix-table input[type="radio"] {
    width: 18px !important;
    height: 18px !important;
    transform: scale(0.7) !important;
    margin: 0.15rem !important;
  }
}

</style>

<div class="survey-container">
  <form method="post">
    <div class="form-group" id="llm-familiarity-group">
<label for="llm_familiarity" class="question-label" style="display: block; margin-bottom: 20px;">
        <p><b>Before today, how familiar were you with large language models (LLMs) or artificial intelligence (AI) chatbots like ChatGPT, Gemini, or Claude?</b></p>
      </label>
      <div>
        <input type="radio" id="llm_have_not_heard" name="llm_familiarity" value="Have not heard about them">
        <label for="llm_have_not_heard">Have not heard about them</label>
      </div>
      <div>
        <input type="radio" id="llm_a_little" name="llm_familiarity" value="Have heard a little about them but have not tried them out">
        <label for="llm_a_little">Have heard a little about them but have not tried them out</label>
      </div>
      <div>
        <input type="radio" id="llm_tried" name="llm_familiarity" value="Have heard about them and have tried them out">
        <label for="llm_tried">Have heard about them and have tried them out</label>
      </div>
      <div>
        <input type="radio" id="llm_sometimes" name="llm_familiarity" value="Use them sometimes in my work or personal life">
        <label for="llm_sometimes">Use them sometimes in my work or personal life</label>
      </div>
      <div>
        <input type="radio" id="llm_frequently" name="llm_familiarity" value="Use them frequently in my work or personal life">
        <label for="llm_frequently">Use them frequently in my work or personal life</label>
      </div>
    </div>

      <!-- Instruction Text -->
<p><b>To what extent do you trust the following actors?</b></p>

<!-- Likert Scale -->
<div class="matrix-wrapper" id="trust-actors-wrapper">
  <table class="matrix-table">
    <colgroup>
      <col style="width: 28%;"> <!-- Question column -->
      <col style="width: 14%;"> <!-- A lot -->
      <col style="width: 14%;"> <!-- Some -->
      <col style="width: 14%;"> <!-- Not too much -->
      <col style="width: 14%;"> <!-- Not at all -->
      <col style="width: 14%;"> <!-- No opinion -->
    </colgroup>
    <thead>
      <tr>
        <th></th>
        <th>A lot</th>
        <th>Some</th>
        <th>Not too much</th>
        <th>Not at all</th>
        <th>No opinion</th>
      </tr>
    </thead>
    <tbody id="trust-actors-rows">
      <tr data-field="trust_AI_company">
        <td class="question-column">{{ form.trust_AI_company.label }}</td>
        {% for choice in form.trust_AI_company %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="trust_user">
        <td class="question-column">{{ form.trust_user.label }}</td>
        {% for choice in form.trust_user %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="trust_smp">
        <td class="question-column">{{ form.trust_smp.label }}</td>
        {% for choice in form.trust_smp %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="trust_journalists_factcheckers">
        <td class="question-column">{{ form.trust_journalists_factcheckers.label }}</td>
        {% for choice in form.trust_journalists_factcheckers %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
    </tbody>
  </table>
</div>


    <!-- Instruction Text -->
<p><b>Please indicate your level of agreement with the following statements regarding social media platforms:</b></p>

<!-- Likert Scale -->
<div class="matrix-wrapper" id="smp-matrix-wrapper">
  <table class="matrix-table">
    <colgroup>
      <col style="width: 28%;"> <!-- Question column -->
      <col style="width: 14%;"> <!-- Strongly Disagree -->
      <col style="width: 14%;"> <!-- Disagree -->
      <col style="width: 14%;"> <!-- Neither -->
      <col style="width: 14%;"> <!-- Agree -->
      <col style="width: 14%;"> <!-- Strongly Agree -->
    </colgroup>
    <thead>
      <tr>
        <th></th>
        <th>Strongly Disagree</th>
        <th>Disagree</th>
        <th>Neither Agree Nor Disagree</th>
        <th>Agree</th>
        <th>Strongly Agree</th>
      </tr>
    </thead>
    <tbody id="smp-post-rows">
      <tr data-field="smp_entertaining_post">
        <td class="question-column">{{ form.smp_entertaining_post.label }}</td>
        {% for choice in form.smp_entertaining_post %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="smp_accuracy_post">
        <td class="question-column">{{ form.smp_accuracy_post.label }}</td>
        {% for choice in form.smp_accuracy_post %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="smp_enjoyment_post">
        <td class="question-column">{{ form.smp_enjoyment_post.label }}</td>
        {% for choice in form.smp_enjoyment_post %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="smp_community_post">
        <td class="question-column">{{ form.smp_community_post.label }}</td>
        {% for choice in form.smp_community_post %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
      <tr data-field="smp_news_post">
        <td class="question-column">{{ form.smp_news_post.label }}</td>
        {% for choice in form.smp_news_post %}
          <td>{{ choice }}</td>
        {% endfor %}
      </tr>
    </tbody>
  </table>
</div>
    <!-- Instruction Text -->
    <p><b>Please indicate your level of agreement with the following statements regarding artificial intelligence:</b></p>

    <!-- Likert Scale -->
<div class="matrix-wrapper" id="ai-matrix-wrapper">
  <table class="matrix-table">
    <colgroup>
      <col style="width: 28%;">
      <col style="width: 14%;">
      <col style="width: 14%;">
      <col style="width: 14%;">
      <col style="width: 14%;">
      <col style="width: 14%;">
    </colgroup>
    <thead>  <!-- Add this -->
      <tr>
          <th></th>
          <th>Strongly Disagree</th>
          <th>Disagree</th>
          <th>Neither Agree Nor Disagree</th>
          <th>Agree</th>
          <th>Strongly Agree</th>
        </tr>
    </thead>  <!-- Add this -->
    <tbody>  <!-- Add this -->
        <tr data-field="benefits_ai">
          <td class="question-column">{{ form.benefits_ai.label }}</td>
          {% for choice in form.benefits_ai %}
            <td>{{ choice }}</td>
          {% endfor %}
        </tr>
        <tr data-field="distinguish_ability">
          <td class="question-column">{{ form.distinguish_ability.label }}</td>
          {% for choice in form.distinguish_ability %}
            <td>{{ choice }}</td>
          {% endfor %}
        </tr>
     </tbody>
      </table>
    </div>

<!-- Watermark Familiarity Question -->
<div class="form-group" id="watermark-familiarity-group">
  <p><b>Before today, how familiar were you with warning/information labels or watermarks on social media?</b></p>
  <div>
    <input type="radio" id="watermark_very" name="watermark_familiarity" value="Very familiar">
    <label for="watermark_very">Very familiar</label>
  </div>
  <div>
    <input type="radio" id="watermark_somewhat" name="watermark_familiarity" value="Somewhat familiar">
    <label for="watermark_somewhat">Somewhat familiar</label>
  </div>
  <div>
    <input type="radio" id="watermark_not" name="watermark_familiarity" value="Not familiar at all">
    <label for="watermark_not">Not familiar at all</label>
  </div>
</div>


    <div class="submit-container">
      <button type="submit" id="submitButton" aria-label="Submit survey responses">
        ➔
      </button>
    </div>
  </form>
</div>

<script>
// Randomize trust actors rows using stored order
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('trust-actors-rows');
    if (!tbody) return;

    // Get the stored order from the server
    const trustActorsOrder = {{ participant.vars.trust_actors_order|json }};

    if (trustActorsOrder && trustActorsOrder.length > 0) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Create a map of field name to row
        const rowMap = {};
        rows.forEach(row => {
            const fieldName = row.getAttribute('data-field');
            if (fieldName) {
                rowMap[fieldName] = row;
            }
        });

        // Clear tbody
        tbody.innerHTML = '';

        // Append rows in the stored order
        trustActorsOrder.forEach(fieldName => {
            if (rowMap[fieldName]) {
                tbody.appendChild(rowMap[fieldName]);
            }
        });
    }
});

// Randomize SMP post statements rows using stored order
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('smp-post-rows');
    if (!tbody) return;

    // Get the stored order from the server
    const smpPostOrder = {{ participant.vars.smp_post_order|json }};

    if (smpPostOrder && smpPostOrder.length > 0) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Create a map of field name to row
        const rowMap = {};
        rows.forEach(row => {
            const fieldName = row.getAttribute('data-field');
            if (fieldName) {
                rowMap[fieldName] = row;
            }
        });

        // Clear tbody
        tbody.innerHTML = '';

        // Append rows in the stored order
        smpPostOrder.forEach(fieldName => {
            if (rowMap[fieldName]) {
                tbody.appendChild(rowMap[fieldName]);
            }
        });
    }
});
// Enhanced validation function with highlighting and detailed messages
function validateForm() {
    console.log('validateForm() called');

    // Define field names with their user-friendly labels
    const requiredFields = {
        'llm_familiarity': 'How familiar you are with large language models',
        'trust_AI_company': 'Trust in the company that built the AI tool',
        'trust_user': 'Trust in the user who posted the content',
        'trust_smp': 'Trust in the social media platform',
        'trust_journalists_factcheckers': 'Trust in journalists or fact-checkers',
        'smp_entertaining_post': 'Social media platforms are entertaining',
        'smp_accuracy_post': 'Social media platform accuracy statement',
        'smp_enjoyment_post': 'Social media enjoyment statement',
        'smp_community_post': 'Social media community statement',
        'smp_news_post': 'Social media news statement',
        'benefits_ai': 'Benefits of AI',
        'distinguish_ability': 'Ability to distinguish AI content',
        'watermark_familiarity': 'Watermark or warning label familiarity'
    };

    const form = document.querySelector('form');
    if (!form) {
        console.log('Form not found');
        return true;
    }

    let unansweredFields = [];
    let missingElements = [];

    // Clear any previous highlighting
    document.querySelectorAll('.missing-answer').forEach(el => {
        el.classList.remove('missing-answer');
    });

    document.querySelectorAll('.missing-answer-row').forEach(el => {
        el.classList.remove('missing-answer-row');
    });

    // Helper function to check if a radio group has a checked input
    function isRadioGroupChecked(name) {
        return document.querySelector(`input[name="${name}"]:checked`) !== null;
    }

    // Check LLM familiarity question
    if (!isRadioGroupChecked('llm_familiarity')) {
        unansweredFields.push(requiredFields['llm_familiarity']);
        const container = document.getElementById('llm-familiarity-group');
        if (container) {
            container.classList.add('missing-answer');
            missingElements.push(container);
        }
    }

    // Check watermark familiarity
if (!isRadioGroupChecked('watermark_familiarity')) {
    unansweredFields.push(requiredFields['watermark_familiarity']);
    const container = document.getElementById('watermark-familiarity-group');
    if (container) {
        container.classList.add('missing-answer');
        missingElements.push(container);
    }
}

    // Check trust actors questions
    const trustActorFields = [
        'trust_AI_company',
        'trust_user',
        'trust_smp',
        'trust_journalists_factcheckers'
    ];

    trustActorFields.forEach(fieldName => {
        if (!isRadioGroupChecked(fieldName)) {
            unansweredFields.push(requiredFields[fieldName]);
            const row = document.querySelector(`tr[data-field="${fieldName}"]`);
            if (row) {
                row.classList.add('missing-answer-row');
                missingElements.push(row);
            }
        }
    });

    // Check social media platform questions
    const smpFields = [
        'smp_entertaining_post',
        'smp_accuracy_post',
        'smp_enjoyment_post',
        'smp_community_post',
        'smp_news_post'
    ];

    smpFields.forEach(fieldName => {
        if (!isRadioGroupChecked(fieldName)) {
            unansweredFields.push(requiredFields[fieldName]);
            const row = document.querySelector(`tr[data-field="${fieldName}"]`);
            if (row) {
                row.classList.add('missing-answer-row');
                missingElements.push(row);
            }
        }
    });

    // Check AI questions
    const aiFields = [
        'benefits_ai',
        'distinguish_ability'
    ];

    aiFields.forEach(fieldName => {
        if (!isRadioGroupChecked(fieldName)) {
            unansweredFields.push(requiredFields[fieldName]);
            const row = document.querySelector(`tr[data-field="${fieldName}"]`);
            if (row) {
                row.classList.add('missing-answer-row');
                missingElements.push(row);
            }
        }
    });

    if (unansweredFields.length > 0) {
        console.log('Validation failed. Unanswered fields:', unansweredFields);

        // Create detailed popup error message
        let message = 'Please answer the following question';
        if (unansweredFields.length > 1) {
            message += 's';
        }
        message += ' before submitting:\n\n';

        unansweredFields.forEach(function(fieldLabel, index) {
            message += '• ' + fieldLabel;
            if (index < unansweredFields.length - 1) {
                message += '\n';
            }
        });

        alert(message);

        // Scroll to first missing question
        if (missingElements.length > 0) {
            missingElements[0].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        return false; // Prevent form submission
    }

    console.log('Validation passed');
    return true; // Allow form submission
}

// Add real-time validation feedback
function addRealTimeValidation() {
    const form = document.querySelector('form');
    if (!form) return;

    // Add change listeners to all radio inputs
    const allRadios = form.querySelectorAll('input[type="radio"]');
    allRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            // Remove highlighting when question is answered
            const fieldName = this.name;

            // For LLM familiarity and watermark familiarity (single question groups)
            if (fieldName === 'llm_familiarity' || fieldName === 'watermark_familiarity') {
                const containerId = fieldName === 'llm_familiarity' ? 'llm-familiarity-group' : 'watermark-familiarity-group';
                const container = document.getElementById(containerId);
                if (container && container.classList.contains('missing-answer')) {
                    container.classList.remove('missing-answer');
                }
            } else {
                // For matrix table rows
                const row = document.querySelector(`tr[data-field="${fieldName}"]`);
                if (row && row.classList.contains('missing-answer-row')) {
                    row.classList.remove('missing-answer-row');
                }
            }
        });
    });
}

// DOM Content Loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up validation...');

    // Initialize real-time validation
    addRealTimeValidation();

    // Add form submit event listener
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submit event caught');
            if (!validateForm()) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
        }, true);
    });
});

// Backup validation on submit button click
document.addEventListener('click', function(e) {
    if (e.target && (e.target.type === 'submit' || e.target.getAttribute('type') === 'submit')) {
        console.log('Submit button clicked, validating...');
        if (!validateForm()) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    }
}, true);
</script>

{% endblock %}