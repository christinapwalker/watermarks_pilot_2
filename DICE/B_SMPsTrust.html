{% extends "global/Page.html" %}

{% block content %}

<style>
  /* ===== Base Styles ===== */
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #222;
    background-color: #f9f9f9;
    margin: 0;
    padding: 0;
  }

  .survey-container {
    max-width: 1400px;
    margin: 40px auto;
    background: white;
    padding: 30px 40px;
    border-radius: 6px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
  }

  p {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .question-label {
    font-size: 1.3rem;
    font-weight: 600;
    color: #222;
  }

  /* ===== Radio Button Container Styling (FIX FOR MOBILE) ===== */
  .form-group div {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 8px;
  }

  .form-group input[type="radio"] {
    flex-shrink: 0;
    margin: 0;
    margin-top: 2px; /* Slight adjustment to align with first line of text */
  }

  .form-group label {
    flex: 1;
    font-size: 1rem;
    font-weight: 400;
    color: #333;
    line-height: 1.4;
    cursor: pointer;
    margin: 0;
  }

  /* ===== Table Styles ===== */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 18px;
    margin-bottom: 40px;
  }

  th, td {
    padding: 12px;
    text-align: center;
    vertical-align: middle;
    font-size: 0.95rem;
    color: #333;
  }

  th {
    font-weight: 600;
    background: #f1f1f1;
    border-bottom: 2px solid #ddd;
  }

  /* Question Column */
  .question-column {
    width: 20%;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    text-align: left;
    font-weight: 600;
    color: #222;
  }

  /* ----- Matrix Table Specific Styles ----- */
  .matrix-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 40px;
    table-layout: fixed;
  }

  .matrix-table th,
  .matrix-table td {
    border: 1px solid #ddd;
    padding: 10px 8px;
    text-align: center;
    vertical-align: middle;
    font-size: 1rem;
    color: #333;
  }

  .matrix-table .question-column {
    width: 30%;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: break-word;
    text-align: left;
    font-weight: 600;
    color: #222;
  }

  /* Radio Answer Columns - equal width for all */
  .matrix-table th:not(:first-child),
  .matrix-table td:not(.question-column) {
    width: auto;
    padding: 4px 2px;
    font-size: 0.85rem;
    word-break: normal;
    text-align: center;
  }

  /* Radio Inputs */
  .matrix-table input[type="radio"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  /* Hide mobile labels on desktop */
  .matrix-table td label.mobile-label {
    display: none;
  }

  /* Wrapper for horizontal scroll on small screens */
  .matrix-wrapper {
    overflow-x: auto;
    width: 100%;
  }

  .matrix-wrapper {
    overflow-x: hidden;
    width: 100%;
  }

  /* ===== ERROR STYLING (matching other pages) ===== */
  /* Validation highlighting styles */
  .missing-answer {
    background-color: #ffebee !important;
    border: 2px solid #f44336 !important;
    border-radius: 4px;
    padding: 8px;
    margin: 4px 0;
    animation: pulse-red 1s ease-in-out;
  }

  .missing-answer .question-column {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer .question-label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer p {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer > label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  /* Special styling for matrix table rows with missing answers */
  .missing-answer-row {
    background-color: #ffebee !important;
    animation: pulse-red 1s ease-in-out;
  }

  .missing-answer-row td {
    background-color: #ffebee !important;
    border: 1px solid #f44336 !important;
  }

  .missing-answer-row .question-column {
    color: #d32f2f !important;
    font-weight: bold;
  }

  @keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
    100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
  }

  /* Submit button container */
  .submit-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 30px;
  }

  button[type="submit"] {
    background-color: #2c7be5;
    color: white;
    border: none;
    padding: 10px 22px;
    font-size: 1.3rem;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(44,123,229,0.4);
    transition: background-color 0.25s ease;
  }

  button[type="submit"]:hover {
    background-color: #1a5fd9;
  }

  /* ===== Responsive ===== */
  @media (max-width: 700px) {
    .survey-container {
      margin: 15px;
      padding: 20px;
    }

    /* Mobile Radio Button Fixes */
    .form-group div {
      margin-bottom: 15px;
      gap: 10px;
    }

    .form-group label {
      font-size: 0.9rem;
      line-height: 1.3;
    }

    .form-group input[type="radio"] {
      width: 18px;
      height: 18px;
      margin-top: 1px;
    }

    p, .slider-value {
      font-size: 1rem;
    }

    .matrix-table th,
    .matrix-table td {
      font-size: 0.75rem;
      padding: 6px;
    }

    .matrix-table {
      width: 100%;
      table-layout: fixed;
    }

    .question-label {
      font-size: 1rem;
    }

    /* Slightly wider question column */
    .matrix-table .question-column {
      width: 50%;
      font-size: 0.5rem;
      padding-left: 1px;
      padding-right: 1px;
      word-break: break-word;
      white-space: normal;
    }

    /* Make radio columns narrow */
    .matrix-table th:not(:first-child),
    .matrix-table td:not(.question-column) {
      max-width: 1px;
      white-space: normal;
      word-break: break-word;
      padding: 0px 0px;
      font-size: 0.6rem;
    }
  }
</style>

<script>
// Handle color check checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const colorCheckboxes = document.querySelectorAll('.color-checkbox');
    const colorHiddenInput = document.getElementById('color_check');

    // Update hidden input when checkboxes change
    colorCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const checkedValues = Array.from(colorCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Store as comma-separated string
            colorHiddenInput.value = checkedValues.join(',');
        });
    });

    // Load pre-existing values if any (for page refresh)
    if (colorHiddenInput.value) {
        const values = colorHiddenInput.value.split(',');
        colorCheckboxes.forEach(function(checkbox) {
            if (values.includes(checkbox.value)) {
                checkbox.checked = true;
            }
        });
    }
});



// Randomize social media rows using stored order
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('social-media-rows');
    if (!tbody) return;

    // Get the stored order from the server
    const socialMediaOrder = {{ participant.vars.social_media_order|json }};

    if (socialMediaOrder && socialMediaOrder.length > 0) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Create a map of field name to row
        const rowMap = {};
        rows.forEach(row => {
            const input = row.querySelector('input[type="radio"]');
            if (input && input.name) {
                rowMap[input.name] = row;
            }
        });

        // Clear tbody
        tbody.innerHTML = '';

        // Append rows in the stored order
        socialMediaOrder.forEach(fieldName => {
            if (rowMap[fieldName]) {
                tbody.appendChild(rowMap[fieldName]);
            }
        });
    }
});

// Randomize social media rows using stored order
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('social-media-rows');
    // ... existing social media code ...
});

// ADD THIS - Randomize SMP statements rows using stored order
document.addEventListener('DOMContentLoaded', function() {
    const smpTbody = document.getElementById('smp-statements-rows');
    if (!smpTbody) return;

    // Get the stored order from the server
    const smpOrder = {{ participant.vars.smp_order|json }};

    if (smpOrder && smpOrder.length > 0) {
        const rows = Array.from(smpTbody.querySelectorAll('tr'));

        // Create a map of field name to row
        const rowMap = {};
        rows.forEach(row => {
            const input = row.querySelector('input[type="radio"]');
            if (input && input.name) {
                rowMap[input.name] = row;
            }
        });

        // Clear tbody
        smpTbody.innerHTML = '';

        // Append rows in the stored order
        smpOrder.forEach(fieldName => {
            const fullFieldName = fieldName + '_pre'; // Add '_pre' suffix
            if (rowMap[fullFieldName]) {
                smpTbody.appendChild(rowMap[fullFieldName]);
            }
        });
    }
});

// Enhanced validation function with highlighting and detailed messages
function validateForm() {
    console.log('validateForm() called');

    // Define field names with their user-friendly labels
    const requiredFields = {
        'party_id': 'Political party identification',
        'use_twitter': 'How often you use Twitter/X',
        'use_reddit': 'How often you use Reddit',
        'use_instagram': 'How often you use Instagram',
        'use_pinterest': 'How often you use Pinterest',
        'use_linkedin': 'How often you use LinkedIn',
        'use_facebook': 'How often you use Facebook',
        'use_youtube': 'How often you use YouTube',
        'use_tiktok': 'How often you use TikTok',
        'use_bluesky': 'How often you use Bluesky',
        'use_truthsocial': 'How often you use Truth Social',
        'smp_entertaining_pre': 'Social media platforms are entertaining',
        'smp_accuracy_pre': 'Social media platform accuracy statement',
        'smp_enjoyment_pre': 'Social media enjoyment statement',
        'smp_community_pre': 'Social media community statement',
        'smp_news_pre': 'Social media news statement',
        'color_check': 'Color preference check'
    };

    const form = document.querySelector('form');
    if (!form) {
        console.log('Form not found');
        return true;
    }

    let unansweredFields = [];
    let missingElements = [];

    // Clear any previous highlighting
    document.querySelectorAll('.missing-answer').forEach(el => {
        el.classList.remove('missing-answer');
    });

    document.querySelectorAll('.missing-answer-row').forEach(el => {
        el.classList.remove('missing-answer-row');
    });

    // Helper function to check if a radio group has a checked input
    function isRadioGroupChecked(name) {
        return document.querySelector(`input[name="${name}"]:checked`) !== null;
    }

    // Check party_id
    if (!isRadioGroupChecked('party_id')) {
        unansweredFields.push(requiredFields['party_id']);
        const container = document.querySelector('.radio-container');
        if (container) {
            container.classList.add('missing-answer');
            missingElements.push(container);
        }
    }

    // Check social media usage questions
    const socialMediaFields = [
        'use_twitter',
        'use_reddit',
        'use_instagram',
        'use_pinterest',
        'use_linkedin',
        'use_facebook',
        'use_youtube',
        'use_tiktok',
        'use_bluesky',
        'use_truthsocial'
    ];

    socialMediaFields.forEach(fieldName => {
        if (!isRadioGroupChecked(fieldName)) {
            unansweredFields.push(requiredFields[fieldName]);
            const row = document.querySelector(`tr:has(input[name="${fieldName}"])`);
            if (row) {
                row.classList.add('missing-answer-row');
                missingElements.push(row);
            }
        }
    });

    // Check SMP statements
    const smpFields = [
        'smp_entertaining_pre',
        'smp_accuracy_pre',
        'smp_enjoyment_pre',
        'smp_community_pre',
        'smp_news_pre'
    ];

    smpFields.forEach(fieldName => {
        if (!isRadioGroupChecked(fieldName)) {
            unansweredFields.push(requiredFields[fieldName]);
            const row = document.querySelector(`tr:has(input[name="${fieldName}"])`);
            if (row) {
                row.classList.add('missing-answer-row');
                missingElements.push(row);
            }
        }
    });

    // Check color check
    const colorField = form.querySelector('input[name="color_check"]');
    if (colorField && colorField.value.trim() === '') {
        unansweredFields.push(requiredFields['color_check']);
        const container = document.getElementById('color-check-group');
        if (container) {
            container.classList.add('missing-answer');
            missingElements.push(container);
        }
    }

    if (unansweredFields.length > 0) {
        console.log('Validation failed. Unanswered fields:', unansweredFields);

        let message = 'Please answer the following question';
        if (unansweredFields.length > 1) {
            message += 's';
        }
        message += ' before submitting:\n\n';

        unansweredFields.forEach(function(fieldLabel, index) {
            message += '• ' + fieldLabel;
            if (index < unansweredFields.length - 1) {
                message += '\n';
            }
        });

        alert(message);

        if (missingElements.length > 0) {
            missingElements[0].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        return false;
    }

    console.log('Validation passed');
    return true;
}

// Add real-time validation feedback
function addRealTimeValidation() {
    const form = document.querySelector('form');
    if (!form) return;

    const allRadios = form.querySelectorAll('input[type="radio"]');
    allRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
            const fieldName = this.name;

            if (fieldName === 'party_id') {
                const container = document.querySelector('.radio-container');
                if (container && container.classList.contains('missing-answer')) {
                    container.classList.remove('missing-answer');
                }
            } else {
                const row = this.closest('tr');
                if (row && row.classList.contains('missing-answer-row')) {
                    row.classList.remove('missing-answer-row');
                }
            }
        });
    });

    // Add listener for color checkboxes
    const colorCheckboxes = form.querySelectorAll('.color-checkbox');
    colorCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const container = document.getElementById('color-check-group');
            if (container && container.classList.contains('missing-answer')) {
                container.classList.remove('missing-answer');
            }
        });
    });
}

// DOM Content Loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up validation...');

    addRealTimeValidation();

    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submit event caught');
            if (!validateForm()) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
        }, true);
    });
});

// Backup validation on submit button click
document.addEventListener('click', function(e) {
    if (e.target && (e.target.type === 'submit' || e.target.getAttribute('type') === 'submit')) {
        console.log('Submit button clicked, validating...');
        if (!validateForm()) {
            e.preventDefault();
            e.stopImmediatePropagation();
            return false;
        }
    }
}, true);
</script>

<div class="survey-container">
  <form method="post">
    <div class="radio-container" style="margin-bottom: 30px;">
      <p class="question-text"><b>{{ form.party_id.label }}</b></p>
      {{ form.party_id }}
      <div class="error-message">{{ formfield_errors 'party_id' }}</div>
    </div>

    <!-- Instruction Text -->
    <p class="question-text"><b>Thinking about social networking sites, how often do you visit or use the following?</b></p>

    <!-- Likert Scale -->
    <div class="matrix-wrapper">
      <table class="matrix-table">
        <thead>
          <tr>
            <th></th>
            <th>Several times a day</th>
            <th>About once a day</th>
            <th>A few days a week</th>
            <th>Every few weeks</th>
            <th>Less often</th>
            <th>Never</th>
            <th>Don't know</th>
          </tr>
        </thead>
        <tbody id="social-media-rows">
          <tr>
            <td class="question-column">
              {{ form.use_twitter.label }}
              <div id="errorUseTwitter" class="error-message">{{ formfield_errors 'use_twitter' }}</div>
            </td>
            {% for choice in form.use_twitter %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_reddit.label }}
              <div id="errorUseReddit" class="error-message">{{ formfield_errors 'use_reddit' }}</div>
            </td>
            {% for choice in form.use_reddit %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_instagram.label }}
              <div id="errorUseInstagram" class="error-message">{{ formfield_errors 'use_instagram' }}</div>
            </td>
            {% for choice in form.use_instagram %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_pinterest.label }}
              <div id="errorUsePinterest" class="error-message">{{ formfield_errors 'use_pinterest' }}</div>
            </td>
            {% for choice in form.use_pinterest %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_linkedin.label }}
              <div id="errorUseLinkedIn" class="error-message">{{ formfield_errors 'use_linkedin' }}</div>
            </td>
            {% for choice in form.use_linkedin %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_facebook.label }}
              <div id="errorUseFacebook" class="error-message">{{ formfield_errors 'use_facebook' }}</div>
            </td>
            {% for choice in form.use_facebook %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_youtube.label }}
              <div id="errorUseYouTube" class="error-message">{{ formfield_errors 'use_youtube' }}</div>
            </td>
            {% for choice in form.use_youtube %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_tiktok.label }}
              <div id="errorUseTikTok" class="error-message">{{ formfield_errors 'use_tiktok' }}</div>
            </td>
            {% for choice in form.use_tiktok %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_bluesky.label }}
              <div id="errorUseBluesky" class="error-message">{{ formfield_errors 'use_bluesky' }}</div>
            </td>
            {% for choice in form.use_bluesky %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.use_truthsocial.label }}
              <div id="errorUsetruthsocial" class="error-message">{{ formfield_errors 'use_truthsocial' }}</div>
            </td>
            {% for choice in form.use_truthsocial %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Instruction Text -->
    <p class="question-text"><b>Please indicate your level of agreement with the following statements regarding social media platforms:</b></p>

    <!-- Likert Scale -->
    <div class="matrix-wrapper">
      <table class="matrix-table">
        <thead>
          <tr>
            <th></th>
            <th>Strongly Disagree</th>
            <th>Disagree</th>
            <th>Neither Agree Nor Disagree</th>
            <th>Agree</th>
            <th>Strongly Agree</th>
          </tr>
        </thead>
        <tbody id="smp-statements-rows">
          <tr>
            <td class="question-column">
              {{ form.smp_entertaining_pre.label }}
              <div id="errorSmpEntertainingPre" class="error-message">{{ formfield_errors 'smp_entertaining_pre' }}</div>
            </td>
            {% for choice in form.smp_entertaining_pre %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.smp_accuracy_pre.label }}
              <div id="errorSmpAccuracyPre" class="error-message">{{ formfield_errors 'smp_accuracy_pre' }}</div>
            </td>
            {% for choice in form.smp_accuracy_pre %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.smp_enjoyment_pre.label }}
              <div id="errorSmpEnjoymentPre" class="error-message">{{ formfield_errors 'smp_enjoyment_pre' }}</div>
            </td>
            {% for choice in form.smp_enjoyment_pre %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.smp_community_pre.label }}
              <div id="errorSmpCommunityPre" class="error-message">{{ formfield_errors 'smp_community_pre' }}</div>
            </td>
            {% for choice in form.smp_community_pre %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>

          <tr>
            <td class="question-column">
              {{ form.smp_news_pre.label }}
              <div id="errorSmpNewsPre" class="error-message">{{ formfield_errors 'smp_news_pre' }}</div>
            </td>
            {% for choice in form.smp_news_pre %}
              <td data-label="">{{ choice|safe }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Color Preference Attention Check -->
<div class="form-group" id="color-check-group" style="margin-top: 40px;">
          <p class="question-text"><b>Now, we would like to get a sense of your general preferences.  Most modern theories of decision-making recognize that decisions do not take place in a vacuum. Individual preferences and knowledge, along with situational variables, can greatly impact the decision process. To demonstrate that you read this much, just go ahead and select both black and green among the alternatives below, no matter what your favorite color is. Yes, ignore the question below and select both of those options.</p>


  <label class="question-text" style="display: block; margin-bottom: 15px;">
    <p class="question-text"><b>What is your favorite color?</b></p>
  </label>

  <!-- Hidden input to store the selected values -->
  <input type="hidden" id="color_check" name="color_check" value="">

  <div style="display: flex; flex-direction: column; gap: 10px;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="color_white" class="color-checkbox" value="White">
      <label for="color_white" style="font-weight: 400; cursor: pointer; margin: 0;">White</label>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="color_black" class="color-checkbox" value="Black">
      <label for="color_black" style="font-weight: 400; cursor: pointer; margin: 0;">Black</label>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="color_red" class="color-checkbox" value="Red">
      <label for="color_red" style="font-weight: 400; cursor: pointer; margin: 0;">Red</label>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="color_pink" class="color-checkbox" value="Pink">
      <label for="color_pink" style="font-weight: 400; cursor: pointer; margin: 0;">Pink</label>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="color_green" class="color-checkbox" value="Green">
      <label for="color_green" style="font-weight: 400; cursor: pointer; margin: 0;">Green</label>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" id="color_blue" class="color-checkbox" value="Blue">
      <label for="color_blue" style="font-weight: 400; cursor: pointer; margin: 0;">Blue</label>
    </div>
  </div>

  <div class="error-message">{{ formfield_errors 'color_check' }}</div>
</div>

    <div class="submit-container">
      <button type="submit" id="submitButton" aria-label="Submit survey responses">
        ➔
      </button>
    </div>
  </form>
</div>

{% endblock %}