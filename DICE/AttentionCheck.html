{% extends "global/Page.html" %}

{% block content %}

<style>
  /* ===== Base Styles ===== */
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    color: #222;
    background-color: #f9f9f9;
    margin: 0;
    padding: 0;
  }

  .survey-container {
    max-width: 1400px;
    margin: 40px auto;
    background: white;
    padding: 30px 40px;
    border-radius: 6px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
  }

  p {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .question-label {
    font-size: 1.5rem;
    font-weight: 600;
    color: #222;
  }

  /* ===== Form Group Styling ===== */
  .form-group {
    margin-bottom: 30px;
  }

  .form-group label {
    font-size: 1.5rem;
    font-weight: 400;
    color: #333;
    line-height: 1.4;
    cursor: pointer;
    margin: 0;
  }

  .form-group input[type="text"] {
    width: 100%;
    max-width: 500px;
    padding: 10px;
    font-size: 1.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-top: 10px;
  }

  /* ===== ERROR STYLING ===== */
  .missing-answer {
    background-color: #ffebee !important;
    border: 2px solid #f44336 !important;
    border-radius: 4px;
    padding: 8px;
    margin: 4px 0;
    animation: pulse-red 1s ease-in-out;
  }

  .missing-answer .question-label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer p {
    color: #d32f2f !important;
    font-weight: bold;
  }

  .missing-answer > label {
    color: #d32f2f !important;
    font-weight: bold;
  }

  @keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
    100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
  }

  /* Submit button container */
  .submit-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 30px;
  }

  button[type="submit"] {
    background-color: #2c7be5;
    color: white;
    border: none;
    padding: 10px 22px;
    font-size: 1.5rem;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
    box-shadow: 0 5px 10px rgba(44,123,229,0.4);
    transition: background-color 0.25s ease;
  }

  button[type="submit"]:hover {
    background-color: #1a5fd9;
  }

  /* ===== Responsive ===== */
  @media (max-width: 700px) {
    .survey-container {
      margin: 15px;
      padding: 20px;
    }

    p {
      font-size: .9rem;
    }

    .question-label {
      font-size: .9rem;
    }

      /* Make form labels smaller on mobile */
  .form-group label {
    font-size: 0.9rem !important;
  }

  /* Make input text smaller on mobile */
  .form-group input[type="text"] {
    font-size: 0.9rem;
  }

  /* Make attention check paragraphs smaller on mobile */
  #attention-check-group p {
    font-size: 0.85rem !important;
  }

  /* Make checkbox labels smaller on mobile */
  #attention-check-group label[for^="feeling_"] {
    font-size: 0.9rem !important;
  }

  /* Make button smaller on mobile */
  button[type="submit"] {
    font-size: 1rem;
  }
  }
</style>

<script>
  // Handle attention check checkboxes
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.attention-checkbox');
    const hiddenInput = document.getElementById('attention_check');

    // Update hidden input when checkboxes change
    checkboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const checkedValues = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);

        // Store as comma-separated string
        hiddenInput.value = checkedValues.join(',');
      });
    });

    // Load pre-existing values if any (for page refresh)
    if (hiddenInput.value) {
      const values = hiddenInput.value.split(',');
      checkboxes.forEach(function(checkbox) {
        if (values.includes(checkbox.value)) {
          checkbox.checked = true;
        }
      });
    }
  });

  // Validation function
  function validateForm() {
    console.log('validateForm() called');

    const requiredFields = {
      'prolific_id': 'Prolific ID',
      'attention_check': 'Attention check (feelings question)'
    };

    const form = document.querySelector('form');
    if (!form) {
      console.log('Form not found');
      return true;
    }

    let unansweredFields = [];
    let missingElements = [];

    // Clear any previous highlighting
    document.querySelectorAll('.missing-answer').forEach(el => {
      el.classList.remove('missing-answer');
    });

    // Check Prolific ID
    const prolificField = form.querySelector('input[name="prolific_id"]');
    if (prolificField && prolificField.value.trim() === '') {
      unansweredFields.push(requiredFields['prolific_id']);
      const container = document.getElementById('prolific-id-group');
      if (container) {
        container.classList.add('missing-answer');
        missingElements.push(container);
      }
    }

    // Check attention check
    const attentionField = form.querySelector('input[name="attention_check"]');
    if (attentionField && attentionField.value.trim() === '') {
      unansweredFields.push(requiredFields['attention_check']);
      const container = document.getElementById('attention-check-group');
      if (container) {
        container.classList.add('missing-answer');
        missingElements.push(container);
      }
    }

    if (unansweredFields.length > 0) {
      console.log('Validation failed. Unanswered fields:', unansweredFields);

      let message = 'Please answer the following question';
      if (unansweredFields.length > 1) {
        message += 's';
      }
      message += ' before submitting:\n\n';

      unansweredFields.forEach(function(fieldLabel, index) {
        message += '• ' + fieldLabel;
        if (index < unansweredFields.length - 1) {
          message += '\n';
        }
      });

      alert(message);

      if (missingElements.length > 0) {
        missingElements[0].scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }

      return false;
    }

    console.log('Validation passed');
    return true;
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
      form.addEventListener('submit', function(e) {
        if (!validateForm()) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      }, true);
    });
  });

  document.addEventListener('click', function(e) {
    if (e.target && (e.target.type === 'submit' || e.target.getAttribute('type') === 'submit')) {
      if (!validateForm()) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
    }
  }, true);
</script>

<div class="survey-container">
  <form method="post">

    <!-- Prolific ID -->
    <div class="form-group" id="prolific-id-group">
      <label for="prolific_id" class="question-label" style="display: block; margin-bottom: 10px;">
        <strong>Please enter your Prolific ID:</strong>
      </label>
      <input type="text" id="prolific_id" name="prolific_id" value="{{ player.prolific_id }}" placeholder="Enter your Prolific ID">
      <div class="error-message">{{ formfield_errors 'prolific_id' }}</div>
    </div>

    <!-- Attention Check Question -->
    <div class="form-group" id="attention-check-group" style="margin-top: 40px;">
      <p style="font-size: 1.5rem; line-height: 1.6; margin-bottom: 20px;">
        <strong>Before we proceed, we have a question about how you're feeling.</strong>
      </p>

      <p style="font-size: 1.3rem; line-height: 1.6; margin-bottom: 20px; color: #222;">
        Recent research on decision-making shows that choices are affected by context. Differences in how people feel, their previous knowledge and experience, and their environment can affect choices. To help us understand how people make decisions, we are interested in information about you. Specifically, we are interested in whether you actually take the time to read the directions: if not, some results may not tell us very much about decision-making in the real world. <strong>To show that you have read the instructions, please ignore the question about how you are feeling and instead check only the "jittery" option as your answer.</strong> Thank you very much.
      </p>

      <label class="question-label" style="display: block; margin-bottom: 15px;">
        <strong>Please check all words that describe how you are currently feeling.</strong>
      </label>

      <input type="hidden" id="attention_check" name="attention_check" value="">

<div style="display: flex; flex-direction: column; gap: 10px; max-width: 300px;">        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_interested" class="attention-checkbox" value="Interested">
          <label for="feeling_interested" style="font-weight: 400; cursor: pointer; margin: 0;">Interested</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_distressed" class="attention-checkbox" value="Distressed">
          <label for="feeling_distressed" style="font-weight: 400; cursor: pointer; margin: 0;">Distressed</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_excited" class="attention-checkbox" value="Excited">
          <label for="feeling_excited" style="font-weight: 400; cursor: pointer; margin: 0;">Excited</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_upset" class="attention-checkbox" value="Upset">
          <label for="feeling_upset" style="font-weight: 400; cursor: pointer; margin: 0;">Upset</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_strong" class="attention-checkbox" value="Strong">
          <label for="feeling_strong" style="font-weight: 400; cursor: pointer; margin: 0;">Strong</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_guilty" class="attention-checkbox" value="Guilty">
          <label for="feeling_guilty" style="font-weight: 400; cursor: pointer; margin: 0;">Guilty</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_scared" class="attention-checkbox" value="Scared">
          <label for="feeling_scared" style="font-weight: 400; cursor: pointer; margin: 0;">Scared</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_hostile" class="attention-checkbox" value="Hostile">
          <label for="feeling_hostile" style="font-weight: 400; cursor: pointer; margin: 0;">Hostile</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_enthusiastic" class="attention-checkbox" value="Enthusiastic">
          <label for="feeling_enthusiastic" style="font-weight: 400; cursor: pointer; margin: 0;">Enthusiastic</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_proud" class="attention-checkbox" value="Proud">
          <label for="feeling_proud" style="font-weight: 400; cursor: pointer; margin: 0;">Proud</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_irritable" class="attention-checkbox" value="Irritable">
          <label for="feeling_irritable" style="font-weight: 400; cursor: pointer; margin: 0;">Irritable</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_alert" class="attention-checkbox" value="Alert">
          <label for="feeling_alert" style="font-weight: 400; cursor: pointer; margin: 0;">Alert</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_ashamed" class="attention-checkbox" value="Ashamed">
          <label for="feeling_ashamed" style="font-weight: 400; cursor: pointer; margin: 0;">Ashamed</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_inspired" class="attention-checkbox" value="Inspired">
          <label for="feeling_inspired" style="font-weight: 400; cursor: pointer; margin: 0;">Inspired</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_nervous" class="attention-checkbox" value="Nervous">
          <label for="feeling_nervous" style="font-weight: 400; cursor: pointer; margin: 0;">Nervous</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_determined" class="attention-checkbox" value="Determined">
          <label for="feeling_determined" style="font-weight: 400; cursor: pointer; margin: 0;">Determined</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_attentive" class="attention-checkbox" value="Attentive">
          <label for="feeling_attentive" style="font-weight: 400; cursor: pointer; margin: 0;">Attentive</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_jittery" class="attention-checkbox" value="Jittery">
          <label for="feeling_jittery" style="font-weight: 400; cursor: pointer; margin: 0;">Jittery</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_active" class="attention-checkbox" value="Active">
          <label for="feeling_active" style="font-weight: 400; cursor: pointer; margin: 0;">Active</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_afraid" class="attention-checkbox" value="Afraid">
          <label for="feeling_afraid" style="font-weight: 400; cursor: pointer; margin: 0;">Afraid</label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="feeling_none" class="attention-checkbox" value="None of the above">
          <label for="feeling_none" style="font-weight: 400; cursor: pointer; margin: 0;">None of the above</label>
        </div>
      </div>

      <div class="error-message">{{ formfield_errors 'attention_check' }}</div>
    </div>

    <div class="submit-container">
      <button type="submit" id="submitButton" aria-label="Submit survey responses">
        ➔
      </button>
    </div>
  </form>
</div>

{% endblock %}