{% block content %}
<form method="post">
  <style>
    .qualtrics-container {
      max-width: none;
      margin: auto;
      padding: 1rem;
    }

    .qualtrics-container label:first-of-type {
      font-size: 1.2rem;
      font-weight: bold;
      display: block;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      table-layout: fixed;
      background-color: #fff;
    }

    th, td {
      text-align: center;
      vertical-align: middle;
      padding: 12px;
      border: none;
    }

    th {
      font-weight: bold;
      font-size: 0.95rem;
    }

    td {
      background-color: #f7f7f7;
      border-radius: 8px;
    }

    td:first-child,
    th:first-child {
      width: 45%;
    }

    td:not(:first-child),
    th:not(:first-child) {
      width: 12%;
    }

    img {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      display: block;
      margin: auto;
    }

    input[type="radio"] {
      transform: scale(1.3);
      margin: 0.5rem;
      cursor: pointer;
    }

    label[for^="moreposts_"] {
      display: inline-block;
      width: 100%;
    }

    @media (max-width: 768px) {
      th, td {
        font-size: 0.85rem;
        padding: 4px;
      }
    }

    /* Submit button container */
    .submit-container {
      display: flex;
      justify-content: flex-end;
      margin-top: 30px;
    }

    button[type="submit"] {
      background-color: #2c7be5;
      color: white;
      border: none;
      padding: 10px 22px;
      font-size: 1.3rem;
      font-weight: 700;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 5px 10px rgba(44,123,229,0.4);
      transition: background-color 0.25s ease;
    }

    button[type="submit"]:hover {
      background-color: #1a5fd9;
    }

    /* ===== ERROR MESSAGE STYLES (matching other pages) ===== */
    .error-message {
        color: red !important;
        font-size: 0.75rem !important;
        padding: 4px 6px !important;
        white-space: normal !important;
        word-break: break-word !important;
        display: block !important;
        max-width: 100% !important;
        overflow-wrap: break-word !important;
        margin-top: 4px;
        min-height: 16px;
        text-align: left;
    }

    /* Validation highlighting styles (matching other pages) */
    .missing-answer {
        background-color: #ffebee !important;
        border: 2px solid #f44336 !important;
        border-radius: 4px;
        padding: 8px;
        margin: 4px 0;
        animation: pulse-red 1s ease-in-out;
    }

    .missing-answer .question-text {
        color: #d32f2f !important;
        font-weight: bold;
    }

    .missing-answer p {
        color: #d32f2f !important;
        font-weight: bold;
    }

    .missing-answer > label {
        color: #d32f2f !important;
        font-weight: bold;
    }

    /* Special styling for table rows with missing answers */
    .missing-answer-row {
        background-color: #ffebee !important;
        border: 2px solid #f44336 !important;
        border-radius: 4px;
        animation: pulse-red 1s ease-in-out;
    }

    .missing-answer-row td {
        background-color: #ffebee !important;
        border: 1px solid #f44336 !important;
    }

    .missing-answer-row td:first-child {
        border-left: 2px solid #f44336 !important;
    }

    .missing-answer-row td:last-child {
        border-right: 2px solid #f44336 !important;
    }

    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
        100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    /* Error container for the overall form */
    .form-error-container {
        margin-bottom: 20px;
    }
  </style>

  <div class="qualtrics-container">
    <label><strong>For each post below, please indicate whether you would like to see more posts like that.</strong></label>



    <table>
      <thead>
        <tr>
          <th> </th>
          <th>Would like to see more</th>
          <th>No opinion</th>
          <th>Would not like to see more</th>
        </tr>
      </thead>
      <tbody>
        {% for option in image_options %}
        <tr data-row-index="{{ forloop.counter }}" id="row_{{ forloop.counter }}">
          <td>
            <img src="{{ option }}" alt="Option {{ forloop.counter }}">
          </td>
          <td>
            <input type="radio"
                   id="moreposts_{{ forloop.counter }}_like"
                   name="moreposts_image_check_{{ forloop.counter }}"
                   value="like">
            <label for="moreposts_{{ forloop.counter }}_like"></label>
          </td>
          <td>
            <input type="radio"
                   id="moreposts_{{ forloop.counter }}_neutral"
                   name="moreposts_image_check_{{ forloop.counter }}"
                   value="neutral">
            <label for="moreposts_{{ forloop.counter }}_neutral"></label>
          </td>
          <td>
            <input type="radio"
                   id="moreposts_{{ forloop.counter }}_dislike"
                   name="moreposts_image_check_{{ forloop.counter }}"
                   value="dislike">
            <label for="moreposts_{{ forloop.counter }}_dislike"></label>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="submit-container">
      <button type="submit" id="submitButton" aria-label="Submit survey responses">
        ➔
      </button>
    </div>
  </div>
</form>

<script>
  // Enhanced validation function with highlighting and popup messages
  function validateForm() {
    console.log('validateForm() called');

    const form = document.querySelector('form');
    if (!form) {
      console.log('Form not found');
      return true;
    }

    let unansweredFields = [];
    let missingRows = [];

    // Clear any previous highlighting
    document.querySelectorAll('.missing-answer-row').forEach(el => {
      el.classList.remove('missing-answer-row');
    });

    document.querySelectorAll('.missing-answer').forEach(el => {
      el.classList.remove('missing-answer');
    });

    // Get all radio group names dynamically based on the inputs in the form
    const radioGroups = new Set();
    const radios = document.querySelectorAll('input[type="radio"][name^="moreposts_image_check_"]');
    radios.forEach(radio => radioGroups.add(radio.name));

    // Check each radio group for a checked input
    for (const groupName of radioGroups) {
      const checked = document.querySelector(`input[name="${groupName}"]:checked`);
      if (!checked) {
        // Extract the row number from the group name
        const rowNumber = groupName.replace('moreposts_image_check_', '');
        unansweredFields.push(`Post ${rowNumber}`);

        // Highlight the table row
        const row = document.getElementById(`row_${rowNumber}`);
        if (row) {
          row.classList.add('missing-answer-row');
          missingRows.push(row);
        }
      }
    }

    if (unansweredFields.length > 0) {
      console.log('Validation failed. Unanswered fields:', unansweredFields);

      // Create detailed popup error message
      let message = 'Please answer all questions by selecting an option for each post.\n\n';
      message += `Missing responses for:\n`;
      unansweredFields.forEach(function(fieldLabel, index) {
        message += '• ' + fieldLabel;
        if (index < unansweredFields.length - 1) {
          message += '\n';
        }
      });

      alert(message);

      // Scroll to first missing question
      if (missingRows.length > 0) {
        missingRows[0].scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }

      return false; // Prevent form submission
    }

    console.log('Validation passed');
    return true; // Allow form submission
  }

  // Add real-time validation feedback - removes red highlighting when answered
  function addRealTimeValidation() {
    const form = document.querySelector('form');
    if (!form) return;

    // Add change listeners to all radio inputs
    const allRadios = form.querySelectorAll('input[type="radio"]');
    allRadios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        // Extract row number from name
        const rowNumber = this.name.replace('moreposts_image_check_', '');

        // Remove highlighting when question is answered
        const row = document.getElementById(`row_${rowNumber}`);
        if (row && row.classList.contains('missing-answer-row')) {
          row.classList.remove('missing-answer-row');
        }
      });
    });
  }

  // DOM Content Loaded
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up validation...');

    // Initialize real-time validation
    addRealTimeValidation();

    // Add form submit event listener
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
      form.addEventListener('submit', function(e) {
        console.log('Form submit event caught');
        if (!validateForm()) {
          e.preventDefault();
          e.stopImmediatePropagation();
          return false;
        }
      }, true);
    });
  });

  // Backup validation on submit button click
  document.addEventListener('click', function(e) {
    if (e.target && (e.target.type === 'submit' || e.target.getAttribute('type') === 'submit')) {
      console.log('Submit button clicked, validating...');
      if (!validateForm()) {
        e.preventDefault();
        e.stopImmediatePropagation();
        return false;
      }
    }
  }, true);
</script>

{% endblock %}